name: Create QR Code Workflow for PR

on:
  workflow_dispatch:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: write
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'zulu'
      - name: Setup Android SDK
        uses: android-actions/setup-android@v2
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install dependencies
        run: |
          npm ci
          npm install -g @expo/ngrok@^4.1.0
          npm install -g http-server
      - name: Start Expo server
        run: |
          nohup npx expo start --no-dev --clear --tunnel 2>&1 | tee expo.log &
          echo $! > expo.pid
          sleep 20
        env:
          EXPO_DEBUG: true
      - name: Extract and Display Expo URL
        run: |
          expo_url=$(grep -oP '(?<=URL: ).*' expo.log | tail -n 1)
          if [ -z "$expo_url" ]; then
            echo "Failed to extract Expo URL"
            exit 1
          fi
          echo "EXPO_URL=$expo_url" >> $GITHUB_ENV
          echo "Expo URL: ${{ env.EXPO_URL }}"
      - name: Generate QR Code
        run: |
          sudo apt-get update && sudo apt-get install -y qrencode
          qrencode -o "qr_code_pr${{ github.event.pull_request.number }}.png" "${{ env.EXPO_URL }}"
          echo "Expo URL: ${{ env.EXPO_URL }}"
      - name: Start HTTP Server and Ngrok
        run: |
          mkdir -p public
          cp qr_code_pr${{ github.event.pull_request.number }}.png public/
          nohup http-server ./public -p 8080 &
          echo $! > http-server.pid
          ngrok_url=$(ngrok http 8080 --log=stdout > ngrok.log 2>&1 & sleep 5 && grep -o 'https://.*\.ngrok-free\.app' ngrok.log | head -n1)
          echo "NGROK_URL=$ngrok_url" >> $GITHUB_ENV
      - name: Upload QR Code as artifact
        uses: actions/upload-artifact@v3
        with:
          name: qr-code
          path: qr_code_pr${{ github.event.pull_request.number }}.png
      - name: PR comment with QR Code link
        uses: thollander/actions-comment-pull-request@v3
        with:
          message: |
            Voici le QR Code pour tester votre application Expo :
            ![QR Code](${{ env.NGROK_URL }}/qr_code_pr${{ github.event.pull_request.number }}.png)
            Et le lien de l'application Expo :
            ${{ env.EXPO_URL }}
      - name: Sleep 1 hour
        run: |
          sleep 3600
      - name: Launch another workflow
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'qrcode.yml',
              ref: 'main',
            })
